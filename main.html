import React, { useState, useEffect, useMemo } from 'react';
import { 
  Book, 
  Menu, 
  X, 
  Moon, 
  Sun, 
  Search, 
  FileText, 
  ChevronRight,
  AlertCircle,
  Github,
  PenTool,
  Link as LinkIcon
} from 'lucide-react';

// --- CONFIGURATION ---
// Add your markdown files here. 
// The 'path' should be relative to this index.html file.
const ARTICLE_REGISTRY = [
  { 
    id: 'welcome', 
    title: 'Welcome to Your Wiki', 
    category: 'Meta', 
    path: 'welcome.md', 
    description: 'Getting started guide and system overview.'
  },
  { 
    id: 'goals-2025', 
    title: '2025 Vision & Goals', 
    category: 'Personal', 
    path: 'goals.md', 
    description: 'Strategic planning for the upcoming year.'
  },
  { 
    id: 'react-notes', 
    title: 'React Patterns', 
    category: 'Mathematics', 
    path: 'react-patterns.md', 
    description: 'Collection of useful hooks and component patterns.'
  },
  { 
    id: 'finance', 
    title: 'Financial Independence', 
    category: 'Finance', 
    path: 'fire-plan.md', 
    description: 'Investment strategies and savings rate tracking.'
  },
];

// --- MOCK DATA FOR DEMO PURPOSES ---
const FALLBACK_CONTENT = {
  'welcome': `# Welcome to Your Personal Wiki

This is a **beautiful**, lightweight knowledge base that lives entirely in your browser.

## Internal Linking
You can now link to other pages easily!
- **Wiki Style**: Use double brackets like this: [[goals-2025]]
- **Standard Style**: Use normal markdown links like this: [See my 2025 Goals](goals-2025)

## How it works
1. **Create Markdown Files**: Write your notes in your favorite editor (VS Code, Obsidian, etc.) and save them as \`.md\` files in this folder.
2. **Register Them**: Open the source code of this page and add your file to the \`ARTICLE_REGISTRY\` list.
3. **View**: Refresh this page. Your content will appear here!

## Features
* Dark / Light Mode
* Instant Search
* **Internal Linking** (New!)
* Responsive Design

> "The simpler the better." - Unknown
  `,
  'goals-2025': `# 2025 Vision

## Core Principles
1. **Pay Myself First**: Prioritizing health and wealth. See [[finance]] for details.
2. **Write to Learn**: Explaining concepts to solidify understanding.
3. **The Future is Digital**: Embracing CS and Data Science.

## The 10x Engineer
Focusing on deep mastery of:
- Mathematics
- Science
- System Design (See [[react-notes]])
  `,
  'default': `# File Not Found

We tried to load the markdown file for this article, but couldn't find it. 

### Troubleshooting
1. **Local Security**: If you opened this file directly (file://), browsers block loading external files. Try running a local server (e.g. \`npx serve\`).
2. **Check Paths**: Ensure the filename in \`ARTICLE_REGISTRY\` matches your actual file exactly.
  `
};

// --- MARKDOWN PARSER (Lightweight) ---
const parseMarkdown = (text) => {
  if (!text) return '';
  
  let html = text
    // Sanitize basic
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    
    // Headers
    .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-6 pb-2 border-b border-slate-200 dark:border-slate-700">$1</h1>')
    .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-200 mt-8 mb-4">$1</h2>')
    .replace(/^### (.*$)/gim, '<h3 class="text-xl font-medium text-slate-800 dark:text-slate-200 mt-6 mb-3">$1</h3>')
    
    // Blockquotes
    .replace(/^\> (.*$)/gim, '<blockquote class="border-l-4 border-indigo-500 pl-4 italic text-slate-600 dark:text-slate-400 my-4 py-1 bg-slate-50 dark:bg-slate-800/50 rounded-r">$1</blockquote>')
    
    // Bold / Italic
    .replace(/\*\*(.*)\*\*/gim, '<strong class="font-bold text-indigo-600 dark:text-indigo-400">$1</strong>')
    .replace(/\*(.*)\*/gim, '<em class="italic">$1</em>')
    
    // Code Blocks (Basic)
    .replace(/```([\s\S]*?)```/gim, '<pre class="bg-slate-900 text-slate-50 p-4 rounded-lg overflow-x-auto my-6 font-mono text-sm shadow-inner"><code>$1</code></pre>')
    
    // Inline Code
    .replace(/`([^`]+)`/gim, '<code class="bg-slate-100 dark:bg-slate-800 text-pink-600 dark:text-pink-400 px-1.5 py-0.5 rounded font-mono text-sm border border-slate-200 dark:border-slate-700">$1</code>')
    
    // --- LINKS ---
    // 1. External Links (http/https) - Standard behavior, opens in new tab
    .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 hover:underline inline-flex items-center gap-1">$1 <span class="text-[10px] opacity-70">↗</span></a>')

    // 2. Wiki Style Links [[id]] - Converts [[id]] to an internal link
    .replace(/\[\[(.*?)\]\]/g, '<a href="#" data-wiki-link="$1" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium bg-indigo-50 dark:bg-indigo-900/30 px-1 rounded transition-colors">$1</a>')

    // 3. Standard Internal Links [Label](id) - Converts [Label](id) to internal link
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="#" data-wiki-link="$2" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium transition-colors">$1</a>')
    
    // Lists (Unordered)
    .replace(/^\s*-\s+(.*)/gim, '<li class="ml-4 list-disc marker:text-indigo-400 mb-1">$1</li>')
    // Wrap lists in ul (simple heuristic)
    .replace(/(<li.*<\/li>)/gim, '<ul class="my-4 pl-4">$1</ul>')
    // Fix double ul wrapping
    .replace(/<\/ul><ul class="my-4 pl-4">/g, '');

  // Paragraphs
  const parts = html.split(/\n\n/);
  html = parts.map(part => {
    if (part.trim().match(/^<(h|ul|pre|blockquote)/)) return part;
    return `<p class="mb-4 leading-relaxed text-slate-600 dark:text-slate-300">${part}</p>`;
  }).join('\n');

  return html;
};

// --- COMPONENTS ---

const SidebarItem = ({ article, active, onClick }) => (
  <button
    onClick={() => onClick(article)}
    className={`w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group flex items-start gap-3
      ${active 
        ? 'bg-white dark:bg-slate-800 shadow-sm text-indigo-600 dark:text-indigo-400 ring-1 ring-slate-200 dark:ring-slate-700' 
        : 'hover:bg-slate-100 dark:hover:bg-slate-800/50 text-slate-600 dark:text-slate-400'
      }`}
  >
    <FileText size={18} className={`mt-1 flex-shrink-0 ${active ? 'text-indigo-500' : 'text-slate-400 group-hover:text-slate-500'}`} />
    <div>
      <div className={`font-medium ${active ? 'font-semibold' : ''}`}>{article.title}</div>
      {article.description && (
        <div className="text-xs text-slate-400 dark:text-slate-500 mt-1 line-clamp-1">
          {article.description}
        </div>
      )}
    </div>
  </button>
);

const CategorySection = ({ title, articles, currentArticle, onSelect }) => {
  if (articles.length === 0) return null;
  return (
    <div className="mb-6">
      <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-4">
        {title}
      </h3>
      <div className="space-y-1">
        {articles.map(article => (
          <SidebarItem 
            key={article.id} 
            article={article} 
            active={currentArticle?.id === article.id} 
            onClick={onSelect} 
          />
        ))}
      </div>
    </div>
  );
};

export default function PersonalWiki() {
  const [activeArticle, setActiveArticle] = useState(ARTICLE_REGISTRY[0]);
  const [content, setContent] = useState('');
  const [loading, setLoading] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [darkMode, setDarkMode] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [error, setError] = useState(false);

  // Group articles by category
  const groupedArticles = useMemo(() => {
    const filtered = ARTICLE_REGISTRY.filter(a => 
      a.title.toLowerCase().includes(searchQuery.toLowerCase()) || 
      a.description.toLowerCase().includes(searchQuery.toLowerCase())
    );
    
    const groups = {};
    filtered.forEach(article => {
      const cat = article.category || 'Uncategorized';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(article);
    });
    return groups;
  }, [searchQuery]);

  // Handle internal wiki link clicks
  const handleContentClick = (e) => {
    // Check if the clicked element or its parent is a wiki link
    const link = e.target.closest('a[data-wiki-link]');
    if (link) {
      e.preventDefault();
      const id = link.getAttribute('data-wiki-link');
      const targetArticle = ARTICLE_REGISTRY.find(a => a.id === id);
      
      if (targetArticle) {
        setActiveArticle(targetArticle);
      } else {
        console.warn(`Wiki: Article with id "${id}" not found.`);
        // You could add a toast notification here if desired
      }
    }
  };

  // Fetch content
  useEffect(() => {
    const loadContent = async () => {
      setLoading(true);
      setError(false);
      setContent('');

      try {
        const response = await fetch(activeArticle.path);
        
        if (response.ok) {
          const text = await response.text();
          if (text.trim().startsWith('<!DOCTYPE html>')) throw new Error('Not a markdown file');
          setContent(parseMarkdown(text));
        } else {
          throw new Error('File not found');
        }
      } catch (err) {
        console.warn('Wiki: Could not fetch file, using fallback.', err);
        const fallback = FALLBACK_CONTENT[activeArticle.id] || FALLBACK_CONTENT['default'];
        setContent(parseMarkdown(fallback));
        if (!FALLBACK_CONTENT[activeArticle.id]) setError(true);
      } finally {
        setLoading(false);
      }
    };

    loadContent();
    
    if (window.innerWidth < 768) {
      setSidebarOpen(false);
    }
  }, [activeArticle]);

  // Handle Dark Mode toggle
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  return (
    <div className={`min-h-screen flex flex-col md:flex-row transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* Mobile Header */}
      <div className="md:hidden flex items-center justify-between p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-20">
        <div className="flex items-center gap-2 font-bold text-indigo-600 dark:text-indigo-400">
          <Book size={24} />
          <span>Wiki</span>
        </div>
        <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">
          {sidebarOpen ? <X size={24} /> : <Menu size={24} />}
        </button>
      </div>

      {/* Sidebar */}
      <aside 
        className={`
          fixed md:relative z-10 top-0 left-0 h-full w-72 
          bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm md:bg-transparent
          border-r border-slate-200 dark:border-slate-800
          transform transition-transform duration-300 ease-in-out
          flex flex-col
          ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0 md:w-0 md:overflow-hidden md:border-none'}
        `}
      >
        <div className="p-6 pb-2">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-2 font-bold text-xl text-slate-800 dark:text-white">
              <Book className="text-indigo-600 dark:text-indigo-400" />
              <span>Wiki</span>
            </div>
            <button 
              onClick={() => setDarkMode(!darkMode)}
              className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500"
            >
              {darkMode ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>

          <div className="relative mb-6">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <input 
              type="text"
              placeholder="Filter articles..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-9 pr-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
            />
          </div>
        </div>

        <div className="flex-1 overflow-y-auto px-2 pb-6 custom-scrollbar">
          {Object.entries(groupedArticles).map(([category, articles]) => (
            <CategorySection 
              key={category} 
              title={category} 
              articles={articles} 
              currentArticle={activeArticle}
              onSelect={setActiveArticle}
            />
          ))}
          
          {Object.keys(groupedArticles).length === 0 && (
            <div className="text-center p-6 text-slate-400 text-sm">
              No articles found matching "{searchQuery}"
            </div>
          )}
        </div>

        <div className="p-4 border-t border-slate-200 dark:border-slate-800">
           <div className="bg-indigo-50 dark:bg-slate-800 rounded-lg p-3 text-xs text-slate-600 dark:text-slate-400 flex gap-2">
             <AlertCircle size={16} className="text-indigo-500 shrink-0" />
             <p>Add new articles by editing the <code>ARTICLE_REGISTRY</code> array in the source code.</p>
           </div>
        </div>
      </aside>

      {/* Main Content Area */}
      <main className="flex-1 h-[calc(100vh-65px)] md:h-screen overflow-y-auto bg-white dark:bg-slate-950 relative w-full">
        
        {!sidebarOpen && (
          <button 
            onClick={() => setSidebarOpen(true)}
            className="hidden md:flex absolute top-6 left-6 p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 shadow-sm z-10 transition-colors"
            title="Open Sidebar"
          >
            <Menu size={20} />
          </button>
        )}

        <div className="max-w-4xl mx-auto px-6 py-12 md:py-20 min-h-full flex flex-col">
          
          {/* Breadcrumbs */}
          <div className="flex items-center gap-2 text-sm text-slate-400 mb-6">
            <span>{activeArticle.category}</span>
            <ChevronRight size={14} />
            <span className="text-indigo-600 dark:text-indigo-400 font-medium">{activeArticle.title}</span>
          </div>

          {/* Loading State */}
          {loading ? (
            <div className="flex-1 flex flex-col items-center justify-center text-slate-400 animate-pulse">
              <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-1/2 mb-4"></div>
              <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-3/4 mb-4"></div>
              <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-2/3"></div>
            </div>
          ) : (
            // Added onClick handler here for link interception
            <article 
              className="prose prose-slate dark:prose-invert lg:prose-lg max-w-none"
              onClick={handleContentClick}
            >
              <div dangerouslySetInnerHTML={{ __html: content }} />
              
              {error && (
                <div className="mt-8 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-amber-800 dark:text-amber-200 flex items-start gap-3">
                  <AlertCircle className="shrink-0 mt-1" />
                  <div>
                    <h4 className="font-bold">File System Restriction</h4>
                    <p className="text-sm mt-1">
                      If you are seeing this message instead of your content, you are likely opening the HTML file directly. 
                      Browsers block local file access for security. Please open this folder in VS Code and use the "Live Server" extension, 
                      or run <code>npx serve</code> in this directory.
                    </p>
                  </div>
                </div>
              )}
            </article>
          )}

          {/* Footer */}
          <div className="mt-auto pt-20 border-t border-slate-100 dark:border-slate-900">
            <div className="flex items-center justify-between text-slate-400 text-sm">
              <p>© {new Date().getFullYear()} Personal Wiki</p>
              <div className="flex gap-4">
                <span className="hover:text-slate-600 dark:hover:text-slate-300 cursor-pointer">Edit Article</span>
                <span className="hover:text-slate-600 dark:hover:text-slate-300 cursor-pointer">Top of Page</span>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  );
}
