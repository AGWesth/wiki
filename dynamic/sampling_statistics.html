<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero Defect Sampling Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        /* Custom Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #475569;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        .pass-thumb::-webkit-slider-thumb { background: #059669; }
        .fail-thumb::-webkit-slider-thumb { background: #e11d48; }
        
        .pass-track::-webkit-slider-runnable-track { background: #a7f3d0; }
        .fail-track::-webkit-slider-runnable-track { background: #fecdd3; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl overflow-hidden flex flex-col lg:flex-row">
        
        <!-- Controls Panel -->
        <div class="w-full lg:w-1/3 p-8 bg-slate-50 border-r border-slate-100 flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Sampling Statistics</h1>
                <p class="text-sm text-slate-500 mb-6">Zero Defect Plan (c=0).</p>

                <!-- Input: AQL -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-slate-700 text-sm">Target AQL (Max Defects)</label>
                        <span id="val-aql" class="font-mono text-blue-600 font-bold">1.0%</span>
                    </div>
                    <input type="range" id="slider-aql" min="0.1" max="10" step="0.1" value="1.0">
                    <p class="text-[10px] text-slate-400 mt-1">Acceptable Quality Limit</p>
                </div>

                <!-- Input: Confidence -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-slate-700 text-sm">Required Confidence</label>
                        <span id="val-conf" class="font-mono text-blue-600 font-bold">95%</span>
                    </div>
                    <input type="range" id="slider-conf" min="50" max="99" step="1" value="95">
                    <p class="text-[10px] text-slate-400 mt-1">How sure do you want to be?</p>
                </div>

                <div class="border-t border-slate-200 my-4"></div>

                <!-- Input: Sample Size (The Variable) -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-slate-700 text-sm">Sample Size (n)</label>
                        <span id="val-n" class="font-mono text-slate-800 font-bold text-xl">10</span>
                    </div>
                    <input type="range" id="slider-n" min="1" max="500" step="1" value="10">
                    <p class="text-[10px] text-slate-400 mt-1">Slide this to find the green zone</p>
                </div>

                <!-- Status Card -->
                <div id="status-card" class="p-4 rounded-xl text-center border-2 transition-colors duration-300 bg-red-50 border-red-200">
                    <h3 id="status-title" class="text-lg font-bold text-red-700">NOT CONFIDENT</h3>
                    <p id="status-desc" class="text-xs text-red-600 mt-1">
                        Risk is too high (>5%).<br>Increase sample size.
                    </p>
                </div>
            </div>

            <!-- Teaching Panel -->
            <div class="mt-6 pt-4 border-t border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">The Math (Bayesian)</p>
                <div id="math-output" class="text-sm text-slate-600">
                    \[ P(\text{Defect Rate} \le \text{AQL}) \]
                </div>
                <div class="mt-2 text-xs text-slate-500">
                    Current Assurance: <span id="val-assurance" class="font-bold">0%</span>
                </div>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="w-full lg:w-2/3 p-6 bg-white flex flex-col items-center justify-center">
            <div class="w-full h-[400px] relative">
                <canvas id="samplingChart"></canvas>
            </div>
            <div class="flex justify-center space-x-8 mt-4 text-xs">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-slate-300 mr-2"></span>
                    Likely Defect Rate
                </div>
                <div class="flex items-center">
                    <span id="legend-risk" class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                    Risk Area (Rate > AQL)
                </div>
            </div>
        </div>
    </div>

    <script>
        // Register Annotation Plugin
        Chart.register(window['chartjs-plugin-annotation']);

        const ctx = document.getElementById('samplingChart').getContext('2d');
        
        // UI Refs
        const sAql = document.getElementById('slider-aql');
        const sConf = document.getElementById('slider-conf');
        const sN = document.getElementById('slider-n');
        
        const vAql = document.getElementById('val-aql');
        const vConf = document.getElementById('val-conf');
        const vN = document.getElementById('val-n');
        const vAssur = document.getElementById('val-assurance');
        
        const statusCard = document.getElementById('status-card');
        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const legendRisk = document.getElementById('legend-risk');

        // State
        let chart;

        // --- Math Logic ---
        
        // We use the Beta(1, n+1) distribution for the likelihood of 'p' given 0 defects in 'n' trials.
        // PDF: f(x) = (n+1) * (1-x)^n
        function getPDF(x, n) {
            return (n + 1) * Math.pow(1 - x, n);
        }

        // CDF: F(x) = 1 - (1-x)^(n+1)
        function getCDF(x, n) {
            return 1 - Math.pow(1 - x, n + 1);
        }

        function update() {
            const aqlPct = parseFloat(sAql.value);
            const aqlDec = aqlPct / 100;
            const confPct = parseFloat(sConf.value);
            const n = parseInt(sN.value);

            // Update Labels
            vAql.textContent = aqlPct.toFixed(1) + "%";
            vConf.textContent = confPct + "%";
            vN.textContent = n;

            // Calculate Assurance (Area under curve to the left of AQL)
            // Probability that True Defect Rate <= AQL
            const probabilityGood = getCDF(aqlDec, n);
            const probabilityRisk = 1 - probabilityGood; // Area to the right
            
            const assurancePct = (probabilityGood * 100);
            vAssur.textContent = assurancePct.toFixed(2) + "%";

            const isSafe = assurancePct >= confPct;

            // Update UI Colors
            if (isSafe) {
                statusCard.className = "p-4 rounded-xl text-center border-2 transition-colors duration-300 bg-emerald-50 border-emerald-200";
                statusTitle.className = "text-lg font-bold text-emerald-700";
                statusTitle.textContent = "CONFIDENT";
                statusDesc.className = "text-xs text-emerald-600 mt-1";
                statusDesc.textContent = `Risk is low (${(probabilityRisk*100).toFixed(2)}%).\nSample size is sufficient.`;
                
                // Slider styling
                sN.className = "pass-thumb pass-track";
                legendRisk.className = "w-3 h-3 rounded-full bg-emerald-500 mr-2";
            } else {
                statusCard.className = "p-4 rounded-xl text-center border-2 transition-colors duration-300 bg-red-50 border-red-200";
                statusTitle.className = "text-lg font-bold text-red-700";
                statusTitle.textContent = "NOT CONFIDENT";
                statusDesc.className = "text-xs text-red-600 mt-1";
                statusDesc.textContent = `Risk is too high (${(probabilityRisk*100).toFixed(2)}%).\nIncrease sample size.`;
                
                // Slider styling
                sN.className = "fail-thumb fail-track";
                legendRisk.className = "w-3 h-3 rounded-full bg-red-500 mr-2";
            }

            // --- Generate Chart Data ---
            const labels = [];
            const dataPoints = [];
            
            // Dynamic X-axis range. We don't need to show 0-100%, just enough to see the curve.
            // Usually 0 to 4*AQL or 0.15 is enough visually.
            const maxX = Math.max(0.1, aqlDec * 4); 
            const steps = 100;
            
            for(let i=0; i<=steps; i++) {
                const x = (i / steps) * maxX;
                labels.push((x * 100).toFixed(1) + "%");
                dataPoints.push({x: x, y: getPDF(x, n)});
            }

            // Colors
            const colorMain = isSafe ? '#10b981' : '#ef4444'; // Emerald vs Red
            const colorFill = isSafe ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'; 

            // Chart Update
            if (!chart) {
                const config = {
                    type: 'line',
                    data: {
                        labels: labels, // Dummy labels, we use linear scale mostly
                        datasets: [{
                            label: 'Likelihood of Defect Rate',
                            data: dataPoints,
                            borderColor: colorMain,
                            backgroundColor: colorFill,
                            borderWidth: 2,
                            fill: 'start', // Fill area under curve
                            pointRadius: 0,
                            tension: 0.4,
                            segment: {
                                // Advanced coloring: Shade the "Risk" area (Right of AQL) differently
                                backgroundColor: (ctx) => {
                                    // Map point index to X value
                                    const xVal = ctx.p0.parsed.x; 
                                    if (xVal >= aqlDec) return colorFill; // Risk Area
                                    return 'rgba(203, 213, 225, 0.2)'; // Safe Area (Slate)
                                },
                                borderColor: (ctx) => {
                                    const xVal = ctx.p0.parsed.x;
                                    if (xVal >= aqlDec) return colorMain;
                                    return '#94a3b8';
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        interaction: { intersect: false, mode: 'index' },
                        scales: {
                            x: {
                                type: 'linear',
                                min: 0,
                                max: maxX,
                                title: { display: true, text: 'Actual Defect Rate in Lot' },
                                ticks: {
                                    callback: function(value) { return (value*100).toFixed(1) + "%" }
                                }
                            },
                            y: {
                                title: { display: true, text: 'Probability Density' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        xMin: aqlDec,
                                        xMax: aqlDec,
                                        borderColor: '#334155',
                                        borderWidth: 2,
                                        borderDash: [6, 6],
                                        label: {
                                            display: true,
                                            content: 'AQL Limit',
                                            position: 'start',
                                            backgroundColor: '#334155',
                                            color: 'white'
                                        }
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => `Defect Rate: ${(ctx[0].parsed.x * 100).toFixed(2)}%`,
                                    label: (ctx) => `Likelihood: ${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        }
                    }
                };
                chart = new Chart(ctx, config);
            } else {
                // Update existing chart
                chart.data.datasets[0].data = dataPoints;
                
                // Update Annotation (AQL Line)
                chart.options.plugins.annotation.annotations.line1.xMin = aqlDec;
                chart.options.plugins.annotation.annotations.line1.xMax = aqlDec;
                
                // Update Scales if AQL moves significantly
                chart.options.scales.x.max = maxX;

                // Update Segment Colors dynamically
                chart.data.datasets[0].segment.backgroundColor = (ctx) => {
                    const xVal = ctx.p0.parsed.x;
                    if (xVal >= aqlDec) return colorFill;
                    return 'rgba(203, 213, 225, 0.2)'; 
                };
                chart.data.datasets[0].segment.borderColor = (ctx) => {
                    const xVal = ctx.p0.parsed.x;
                    if (xVal >= aqlDec) return colorMain;
                    return '#94a3b8';
                };

                chart.update();
            }
        }

        // Listeners
        sAql.addEventListener('input', update);
        sConf.addEventListener('input', update);
        sN.addEventListener('input', update);

        // Init
        update();

    </script>
</body>
</html>