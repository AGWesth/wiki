<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Interval Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl overflow-hidden flex flex-col lg:flex-row">
        
        <!-- Controls Panel -->
        <div class="w-full lg:w-1/3 p-8 bg-slate-50 border-r border-slate-100 flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Confidence Intervals</h1>
                <p class="text-sm text-slate-500 mb-6">Estimating the Population Mean.</p>

                <!-- Calculation Display -->
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl shadow-sm mb-8">
                    <p class="text-xs font-bold text-blue-400 uppercase mb-2">Calculated Interval</p>
                    <div id="interval-display" class="text-xl font-mono font-bold text-blue-700 text-center">
                        [ 49.00, 51.00 ]
                    </div>
                    <div class="text-center mt-2 text-xs text-blue-500">
                        Margin of Error: Â±<span id="val-moe">1.00</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="space-y-8">
                    <!-- Confidence Level -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-slate-700 text-sm">Confidence Level</label>
                            <span id="val-conf" class="font-mono text-blue-600 font-bold">95%</span>
                        </div>
                        <input type="range" id="slider-conf" min="50" max="99.9" step="0.1" value="95">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                            <span>50%</span>
                            <span>90%</span>
                            <span>95%</span>
                            <span>99%</span>
                        </div>
                    </div>

                    <!-- Sample Size -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-slate-700 text-sm">Sample Size (n)</label>
                            <span id="val-n" class="font-mono text-blue-600 font-bold">30</span>
                        </div>
                        <input type="range" id="slider-n" min="1" max="500" step="1" value="30">
                        <p class="text-[10px] text-slate-400 mt-1">Population \(\sigma = 2\)</p>
                    </div>
                </div>
            </div>

            <!-- Insight -->
            <div class="mt-8 pt-6 border-t border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Formula</p>
                <div class="text-sm text-slate-600 text-center">
                    \[ \bar{x} \pm Z \frac{\sigma}{\sqrt{n}} \]
                </div>
                <p class="text-xs text-slate-500 mt-2 italic">
                    Note how the interval shrinks as \(n\) increases.
                </p>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="w-full lg:w-2/3 p-6 bg-white relative flex items-center justify-center">
            <div class="w-full h-[450px]">
                <canvas id="ciCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        Chart.register(window['chartjs-plugin-annotation']);

        const ctx = document.getElementById('ciCanvas').getContext('2d');
        const sConf = document.getElementById('slider-conf');
        const sN = document.getElementById('slider-n');
        const vConf = document.getElementById('val-conf');
        const vN = document.getElementById('val-n');
        const intervalDisp = document.getElementById('interval-display');
        const vMoe = document.getElementById('val-moe');

        let chart;
        const mean = 50;
        const popStdDev = 2; // Fixed population std dev as requested

        // Standard Normal Inverse CDF (Probit function) approximation
        function getZScore(probability) {
            // Beasley-Springer-Moro Algorithm approx
            const p = probability;
            const a1 = -3.969683028665376e+01;
            const a2 = 2.209460984245205e+02;
            const a3 = -2.759285104469687e+02;
            const a4 = 1.383577518672690e+02;
            const a5 = -3.066479806614716e+01;
            const a6 = 2.506628277459239e+00;

            const b1 = -5.447609879822406e+01;
            const b2 = 1.615858368580409e+02;
            const b3 = -1.556989798598866e+02;
            const b4 = 6.680131188771972e+01;
            const b5 = -1.328068155288572e+01;

            const c1 = -7.784894002430293e-03;
            const c2 = -3.223964580411365e-01;
            const c3 = -2.400758277161838e+00;
            const c4 = -2.549732539343734e+00;
            const c5 = 4.374664141464968e+00;
            const c6 = 2.938163982698783e+00;

            const d1 = 7.784695709041462e-03;
            const d2 = 3.224671290700398e-01;
            const d3 = 2.445134137142996e+00;
            const d4 = 3.754408661907416e+00;

            const p_low = 0.02425;
            const p_high = 1 - 0.02425;

            let q, r;
            if (p < p_low) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            } else if (p <= p_high) {
                q = p - 0.5;
                r = q * q;
                return (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q /
                    (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }
        }

        function normalPDF(x, mu, sigma) {
            return (1 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
        }

        function update() {
            const conf = parseFloat(sConf.value);
            const n = parseInt(sN.value);

            vConf.textContent = conf + "%";
            vN.textContent = n;

            // 1. Calculate Statistics
            const stdErr = popStdDev / Math.sqrt(n); // Standard Error
            const alpha = 1 - (conf / 100);
            const zScore = getZScore(1 - (alpha / 2)); // Two-tailed Z
            const marginOfError = zScore * stdErr;

            const lowerBound = mean - marginOfError;
            const upperBound = mean + marginOfError;

            // Update Text UI
            intervalDisp.textContent = `[ ${lowerBound.toFixed(3)}, ${upperBound.toFixed(3)} ]`;
            vMoe.textContent = marginOfError.toFixed(3);

            // 2. Draw Chart
            drawChart(stdErr, lowerBound, upperBound);
        }

        function drawChart(stdErr, lower, upper) {
            // Visual Range (Fixed mostly, unless SE is huge)
            const range = 4; // Show +/- 4 units around 50
            const minX = 46;
            const maxX = 54;
            
            const labels = [];
            const dataPoints = [];
            const steps = 300;

            for (let i = 0; i <= steps; i++) {
                const x = minX + (i / steps) * (maxX - minX);
                labels.push(x.toFixed(2));
                dataPoints.push({x: x, y: normalPDF(x, mean, stdErr)});
            }

            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sampling Distribution',
                            data: dataPoints,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            segment: {
                                backgroundColor: (ctx) => {
                                    const x = ctx.p0.parsed.x;
                                    // Blue for Inside CI, Red/Gray for Outside
                                    if (x >= lower && x <= upper) return 'rgba(59, 130, 246, 0.3)'; // Blue
                                    return 'rgba(203, 213, 225, 0.4)'; // Gray Tails
                                },
                                borderColor: (ctx) => {
                                    const x = ctx.p0.parsed.x;
                                    if (x >= lower && x <= upper) return '#2563eb';
                                    return '#94a3b8';
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        layout: { padding: { top: 30 } },
                        scales: {
                            x: {
                                type: 'linear',
                                min: minX,
                                max: maxX,
                                grid: { color: '#f1f5f9' },
                                title: { display: true, text: 'Sample Mean Value' }
                            },
                            y: { display: false } // Hide probability density axis
                        },
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: {
                                    lineLower: {
                                        type: 'line',
                                        xMin: lower,
                                        xMax: lower,
                                        borderColor: '#2563eb',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: lower.toFixed(2), 
                                            backgroundColor: 'transparent',
                                            color: '#1e40af',
                                            position: 'start',
                                            yAdjust: -10,
                                            rotation: 0
                                        }
                                    },
                                    lineUpper: {
                                        type: 'line',
                                        xMin: upper,
                                        xMax: upper,
                                        borderColor: '#2563eb',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: upper.toFixed(2), 
                                            backgroundColor: 'transparent',
                                            color: '#1e40af',
                                            position: 'end',
                                            yAdjust: -10,
                                            rotation: 0
                                        }
                                    },
                                    meanLine: {
                                        type: 'line',
                                        xMin: 50,
                                        xMax: 50,
                                        borderColor: '#64748b',
                                        borderWidth: 1,
                                        label: {
                                            display: true,
                                            content: 'Mean (50)',
                                            backgroundColor: '#f1f5f9',
                                            color: '#64748b',
                                            position: 'center',
                                            yAdjust: 5
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = dataPoints;
                
                // Update Colors
                chart.data.datasets[0].segment.backgroundColor = (ctx) => {
                    const x = ctx.p0.parsed.x;
                    if (x >= lower && x <= upper) return 'rgba(59, 130, 246, 0.3)';
                    return 'rgba(203, 213, 225, 0.4)';
                };
                chart.data.datasets[0].segment.borderColor = (ctx) => {
                    const x = ctx.p0.parsed.x;
                    if (x >= lower && x <= upper) return '#2563eb';
                    return '#94a3b8';
                };

                // Update Annotations Positions AND Label Content
                chart.options.plugins.annotation.annotations.lineLower.xMin = lower;
                chart.options.plugins.annotation.annotations.lineLower.xMax = lower;
                chart.options.plugins.annotation.annotations.lineLower.label.content = lower.toFixed(2); 

                chart.options.plugins.annotation.annotations.lineUpper.xMin = upper;
                chart.options.plugins.annotation.annotations.lineUpper.xMax = upper;
                chart.options.plugins.annotation.annotations.lineUpper.label.content = upper.toFixed(2); 

                chart.update();
            }
        }

        sConf.addEventListener('input', update);
        sN.addEventListener('input', update);

        // Init
        update();

    </script>
</body>
</html>