<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Rate Estimator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl overflow-hidden flex flex-col lg:flex-row">
        
        <!-- Controls Panel -->
        <div class="w-full lg:w-1/3 p-8 bg-slate-50 border-r border-slate-100 flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Defect Rate Estimator</h1>
                <p class="text-sm text-slate-500 mb-6">Bayesian Inference (Beta Distribution).</p>

                <!-- Stats Display -->
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl shadow-sm mb-8">
                    <div class="mb-4">
                        <p class="text-xs font-bold text-indigo-400 uppercase mb-1">Observed Rate</p>
                        <p id="disp-observed" class="text-xl font-mono font-bold text-indigo-700">--%</p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-indigo-400 uppercase mb-1">True Rate (95% Confidence)</p>
                        <p id="disp-interval" class="text-sm font-mono text-indigo-600">--</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="space-y-6">
                    <!-- Sample Size -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-slate-700 text-sm">Sample Size (n)</label>
                            <span id="val-n" class="font-mono text-indigo-600 font-bold">100</span>
                        </div>
                        <input type="range" id="slider-n" min="1" max="1000" step="1" value="100">
                    </div>

                    <!-- Defects Found -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-slate-700 text-sm">Defects Found (k)</label>
                            <span id="val-k" class="font-mono text-rose-600 font-bold">5</span>
                        </div>
                        <input type="range" id="slider-k" min="0" max="100" step="1" value="5">
                        <p class="text-[10px] text-slate-400 mt-1">Number of failures in the sample.</p>
                    </div>
                </div>
            </div>

            <!-- Insight -->
            <div class="mt-8 pt-6 border-t border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">The Math</p>
                <div class="text-xs text-slate-600 space-y-2">
                    <p>Likelihood \( \propto p^k (1-p)^{n-k} \)</p>
                    <p>This curve shows the probability of different "True Defect Rates" given your data.</p>
                </div>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="w-full lg:w-2/3 p-6 bg-white relative flex items-center justify-center">
            <div class="w-full h-[500px]">
                <canvas id="betaCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        Chart.register(window['chartjs-plugin-annotation']);

        const ctx = document.getElementById('betaCanvas').getContext('2d');
        const sN = document.getElementById('slider-n');
        const sK = document.getElementById('slider-k');
        const vN = document.getElementById('val-n');
        const vK = document.getElementById('val-k');
        const dispObserved = document.getElementById('disp-observed');
        const dispInterval = document.getElementById('disp-interval');

        let chart;

        // Log Gamma Function (Lanczos approximation) for calculating Beta PDF
        function logGamma(z) {
            const c = [
                0.99999999999980993, 676.5203681218851, -1259.1392167224028,
                771.32342877765313, -176.61502916214059, 12.507343278686905,
                -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7
            ];
            let x = z;
            let y = z;
            let t = z + 7.5;
            let sum = c[0];
            for (let i = 1; i < c.length; i++) {
                sum += c[i] / ++y;
            }
            return 0.5 * Math.log(2 * Math.PI) + (x + 0.5) * Math.log(t) - t + Math.log(sum);
        }

        // Beta PDF: f(x; alpha, beta)
        // alpha = k + 1, beta = n - k + 1 (Uniform Prior)
        function getBetaPDF(x, alpha, beta) {
            if (x <= 0 || x >= 1) return 0;
            // ln(PDF) = (alpha-1)ln(x) + (beta-1)ln(1-x) - ln(B(alpha, beta))
            // ln(B(alpha,beta)) = ln(Gamma(alpha)) + ln(Gamma(beta)) - ln(Gamma(alpha+beta))
            
            const logBetaFunc = logGamma(alpha) + logGamma(beta) - logGamma(alpha + beta);
            const logNumer = (alpha - 1) * Math.log(x) + (beta - 1) * Math.log(1 - x);
            
            return Math.exp(logNumer - logBetaFunc);
        }

        function update() {
            const n = parseInt(sN.value);
            let k = parseInt(sK.value);

            // Constraint: k cannot exceed n
            if (k > n) {
                k = n;
                sK.value = k;
            }
            // Increase max range of slider K if N increases, but cap visually
            sK.max = Math.max(100, Math.min(n, 200)); 

            vN.textContent = n;
            vK.textContent = k;

            const observedRate = (k / n);
            dispObserved.textContent = (observedRate * 100).toFixed(2) + "%";

            // Beta Parameters (Uniform Prior)
            const alpha = k + 1;
            const beta = n - k + 1;

            // Beta Statistics
            const mean = alpha / (alpha + beta);
            const variance = (alpha * beta) / (Math.pow(alpha + beta, 2) * (alpha + beta + 1));
            const stdDev = Math.sqrt(variance);

            // Fixed Scale 0 to 1
            const minX = 0;
            const maxX = 1;
            
            // Generate Points
            const labels = [];
            const dataPoints = [];
            // Increased steps to capture narrow peaks on a wide fixed scale
            const steps = 800; 
            const stepSize = (maxX - minX) / steps;

            for (let i = 0; i <= steps; i++) {
                const x = minX + i * stepSize;
                const y = getBetaPDF(x, alpha, beta);
                
                labels.push((x * 100).toFixed(1) + "%");
                dataPoints.push({x: x, y: y});
            }

            // Approximate 95% CI 
            const ciLower = Math.max(0, mean - 1.96 * stdDev);
            const ciUpper = Math.min(1, mean + 1.96 * stdDev);
            
            dispInterval.textContent = `[ ${(ciLower*100).toFixed(1)}%, ${(ciUpper*100).toFixed(1)}% ]`;

            drawChart(dataPoints, minX, maxX, observedRate, ciLower, ciUpper);
        }

        function drawChart(data, minX, maxX, peakX, lower, upper) {
            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Likelihood',
                            data: data,
                            borderColor: '#4f46e5', // Indigo
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            tension: 0.4,
                            segment: {
                                backgroundColor: (ctx) => {
                                    const x = ctx.p0.parsed.x;
                                    if (x >= lower && x <= upper) return 'rgba(99, 102, 241, 0.4)'; // Darker inside CI
                                    return 'rgba(226, 232, 240, 0.4)'; // Lighter outside
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        scales: {
                            x: {
                                type: 'linear',
                                min: minX,
                                max: maxX,
                                title: { display: true, text: 'Likely Defect Rate (0 - 100%)' },
                                ticks: { callback: (v) => (v*100).toFixed(0) + '%' }
                            },
                            y: { display: false }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => `Rate: ${(ctx[0].parsed.x * 100).toFixed(2)}%`,
                                    label: (ctx) => `Likelihood: ${ctx.parsed.y.toFixed(1)}`
                                }
                            },
                            annotation: {
                                annotations: {
                                    linePeak: {
                                        type: 'line',
                                        xMin: peakX,
                                        xMax: peakX,
                                        borderColor: '#e11d48', // Rose
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: 'Observed',
                                            backgroundColor: '#e11d48',
                                            color: 'white',
                                            position: 'start',
                                            yAdjust: -10
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = data;
                
                chart.options.scales.x.min = minX;
                chart.options.scales.x.max = maxX;
                
                chart.options.plugins.annotation.annotations.linePeak.xMin = peakX;
                chart.options.plugins.annotation.annotations.linePeak.xMax = peakX;

                // Update segments logic for new CI range
                chart.data.datasets[0].segment.backgroundColor = (ctx) => {
                    const x = ctx.p0.parsed.x;
                    if (x >= lower && x <= upper) return 'rgba(99, 102, 241, 0.4)';
                    return 'rgba(226, 232, 240, 0.4)';
                };

                chart.update();
            }
        }

        sN.addEventListener('input', update);
        sK.addEventListener('input', update);

        // Init
        update();

    </script>
</body>
</html>