<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Wiki</title>
    
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- 2. Import Map: Tells browser where to find React and Lucide -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <!-- 3. Babel: Allows us to write JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom Scrollbar for the sidebar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #334155; }
        
        /* Hide scrollbar for embeds but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Smooth transitions */
        body { transition: background-color 0.3s, color 0.3s; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
    
    <div id="root"></div>

    <!-- 4. The Application Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Book, Menu, X, Moon, Sun, Search, FileText, ChevronRight, 
            AlertCircle, Github, PenTool, Loader, Link as LinkIcon, ExternalLink
        } from 'lucide-react';

        // --- FALLBACK / DEMO DATA ---
        const DEMO_REGISTRY = [
            { 
                id: 'demo-welcome', 
                title: 'Welcome (Demo Mode)', 
                category: 'System', 
                path: 'welcome.md', 
                description: 'The registry.json file was not found.'
            }
        ];

        const FALLBACK_CONTENT = {
            'demo-welcome': `# Setup Required

It looks like **registry.json** is missing or cannot be loaded.

## How to fix this
1. Create a file named \`registry.json\` in this folder.
2. Paste your article configuration array into it.
3. Refresh this page.

## Example registry.json
\`\`\`json
[
  {
    "id": "my-first-note",
    "title": "My First Note",
    "category": "Personal",
    "path": "notes.md",
    "description": "A description of the note."
  }
]
\`\`\`
            `,
            'default': `# File Not Found

We tried to load the markdown file for this article, but couldn't find it. 

### Troubleshooting
1. **GitHub Pages**: Ensure your Markdown files and \`registry.json\` are pushed to the repository.
2. **Case Sensitivity**: GitHub is case-sensitive. \`Notes.md\` is different from \`notes.md\`.
            `
        };

        // --- MARKDOWN PARSER ---
        const parseMarkdown = (text) => {
            if (!text) return '';
            
            let html = text
                // 1. Sanitize Basic
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                
                // 2. Headers
                .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-6 pb-2 border-b border-slate-200 dark:border-slate-700">$1</h1>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-200 mt-8 mb-4">$1</h2>')
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-medium text-slate-800 dark:text-slate-200 mt-6 mb-3">$1</h3>')
                
                // 3. Blockquotes
                .replace(/^\> (.*$)/gim, '<blockquote class="border-l-4 border-indigo-500 pl-4 italic text-slate-600 dark:text-slate-400 my-4 py-1 bg-slate-50 dark:bg-slate-800/50 rounded-r">$1</blockquote>')
                
                // 4. Bold / Italic
                .replace(/\*\*(.*)\*\*/gim, '<strong class="font-bold text-indigo-600 dark:text-indigo-400">$1</strong>')
                .replace(/\*(.*)\*/gim, '<em class="italic">$1</em>')
                
                // 5. Code Blocks
                .replace(/```([\s\S]*?)```/gim, '<pre class="bg-slate-900 text-slate-50 p-4 rounded-lg overflow-x-auto my-6 font-mono text-sm shadow-inner"><code>$1</code></pre>')
                .replace(/`([^`]+)`/gim, '<code class="bg-slate-100 dark:bg-slate-800 text-pink-600 dark:text-pink-400 px-1.5 py-0.5 rounded font-mono text-sm border border-slate-200 dark:border-slate-700">$1</code>')
                
                // 6. Embed Syntax: [[embed:path/to/file.html]]
                // Updated to include "no-scrollbar" class
                .replace(/\[\[embed:(.*?)\]\]/g, `
                    <div class="my-6">
                        <div class="w-full h-[600px] border border-slate-200 dark:border-slate-700 rounded-t-lg bg-white overflow-hidden relative">
                            <iframe src="$1" class="w-full h-full no-scrollbar" title="Embedded Content" style="border:0"></iframe>
                        </div>
                        <div class="bg-slate-100 dark:bg-slate-800 border-x border-b border-slate-200 dark:border-slate-700 rounded-b-lg px-4 py-2 flex justify-between items-center">
                            <span class="text-xs text-slate-400 font-mono">$1</span>
                            <a href="$1" target="_blank" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline flex items-center gap-1">
                                Open Source <span>↗</span>
                            </a>
                        </div>
                    </div>
                `)

                // 7. Links
                .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 hover:underline inline-flex items-center gap-1">$1 <span class="text-[10px] opacity-70">↗</span></a>')
                .replace(/\[\[(.*?)\]\]/g, '<a href="#" data-wiki-link="$1" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium bg-indigo-50 dark:bg-indigo-900/30 px-1 rounded transition-colors">$1</a>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="#" data-wiki-link="$2" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium transition-colors">$1</a>')
                
                // 8. Lists
                .replace(/^\s*-\s+(.*)/gim, '<li class="ml-4 list-disc marker:text-indigo-400 mb-1">$1</li>')
                .replace(/(<li.*<\/li>)/gim, '<ul class="my-4 pl-4">$1</ul>')
                .replace(/<\/ul><ul class="my-4 pl-4">/g, '');

            // 9. Paragraphs
            const parts = html.split(/\n\n/);
            html = parts.map(part => {
                if (part.trim().match(/^<(h|ul|pre|blockquote|div)/)) return part; // Added div to skip P wrapping for iframes
                return `<p class="mb-4 leading-relaxed text-slate-600 dark:text-slate-300">${part}</p>`;
            }).join('\n');

            return html;
        };

        // --- COMPONENTS ---

        const SidebarItem = ({ article, active, onClick }) => (
            <button
                onClick={() => onClick(article)}
                className={`w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group flex items-start gap-3
                    ${active 
                        ? 'bg-white dark:bg-slate-800 shadow-sm text-indigo-600 dark:text-indigo-400 ring-1 ring-slate-200 dark:ring-slate-700' 
                        : 'hover:bg-slate-100 dark:hover:bg-slate-800/50 text-slate-600 dark:text-slate-400'
                    }`}
            >
                <FileText size={18} className={`mt-1 flex-shrink-0 ${active ? 'text-indigo-500' : 'text-slate-400 group-hover:text-slate-500'}`} />
                <div>
                    <div className={`font-medium ${active ? 'font-semibold' : ''}`}>{article.title}</div>
                    {article.description && (
                        <div className="text-xs text-slate-400 dark:text-slate-500 mt-1 line-clamp-1">
                            {article.description}
                        </div>
                    )}
                </div>
            </button>
        );

        const CategorySection = ({ title, articles, currentArticle, onSelect }) => {
            if (articles.length === 0) return null;
            return (
                <div className="mb-6">
                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-4">
                        {title}
                    </h3>
                    <div className="space-y-1">
                        {articles.map(article => (
                            <SidebarItem 
                                key={article.id} 
                                article={article} 
                                active={currentArticle?.id === article.id} 
                                onClick={onSelect} 
                            />
                        ))}
                    </div>
                </div>
            );
        };

        function PersonalWiki() {
            const [registry, setRegistry] = useState([]);
            const [registryLoaded, setRegistryLoaded] = useState(false);
            const [activeArticle, setActiveArticle] = useState(null);
            const [content, setContent] = useState('');
            const [loading, setLoading] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [error, setError] = useState(false);
            const [registryError, setRegistryError] = useState(null);

            // 1. Load Registry on Mount
            useEffect(() => {
                const fetchRegistry = async () => {
                    try {
                        const response = await fetch(`./registry.json?t=${new Date().getTime()}`);
                        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                        
                        const text = await response.text();
                        try {
                            const data = JSON.parse(text);
                            if (Array.isArray(data) && data.length > 0) {
                                setRegistry(data);
                                setActiveArticle(data[0]);
                                setRegistryLoaded(true);
                            } else {
                                throw new Error('Registry is empty array');
                            }
                        } catch (e) {
                            throw new Error(`JSON Syntax Error: ${e.message}`);
                        }
                    } catch (err) {
                        console.warn('Wiki: Could not load registry.json', err);
                        setRegistryError(err.message);
                        setRegistry(DEMO_REGISTRY);
                        setActiveArticle(DEMO_REGISTRY[0]);
                        setRegistryLoaded(true);
                    }
                };
                fetchRegistry();
            }, []);

            // 2. Load Article Content
            useEffect(() => {
                if (!activeArticle) return;

                const loadContent = async () => {
                    setLoading(true);
                    setError(false);
                    setContent('');

                    if (registryError && activeArticle.id === 'demo-welcome') {
                        setContent(parseMarkdown(FALLBACK_CONTENT['demo-welcome']));
                        setLoading(false);
                        return;
                    }

                    try {
                        const response = await fetch(activeArticle.path);
                        
                        if (response.ok) {
                            const text = await response.text();
                            if (text.trim().startsWith('<!DOCTYPE html>')) throw new Error('Not a markdown file');
                            setContent(parseMarkdown(text));
                        } else {
                            throw new Error('File not found');
                        }
                    } catch (err) {
                        console.warn('Wiki: Could not fetch file.', err);
                        const fallback = FALLBACK_CONTENT['default'];
                        setContent(parseMarkdown(fallback));
                        setError(true);
                    } finally {
                        setLoading(false);
                    }
                };

                loadContent();
                
                if (window.innerWidth < 768) {
                    setSidebarOpen(false);
                }
            }, [activeArticle, registryError]);

            // Group articles
            const groupedArticles = useMemo(() => {
                if (!registryLoaded) return {};
                
                const filtered = registry.filter(a => 
                    a.title.toLowerCase().includes(searchQuery.toLowerCase()) || 
                    a.description.toLowerCase().includes(searchQuery.toLowerCase())
                );
                
                const groups = {};
                filtered.forEach(article => {
                    const cat = article.category || 'Uncategorized';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(article);
                });
                return groups;
            }, [registry, searchQuery, registryLoaded]);

            // Handle internal links
            const handleContentClick = (e) => {
                const link = e.target.closest('a[data-wiki-link]');
                if (link) {
                    e.preventDefault();
                    const id = link.getAttribute('data-wiki-link');
                    const targetArticle = registry.find(a => a.id === id);
                    if (targetArticle) setActiveArticle(targetArticle);
                }
            };

            // Dark Mode
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // --- RENDER ---
            
            if (!registryLoaded) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 text-slate-400">
                        <div className="flex flex-col items-center gap-4">
                            <Loader className="animate-spin" size={32} />
                            <p>Loading Wiki Configuration...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen flex flex-col md:flex-row transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    
                    {/* Mobile Header */}
                    <div className="md:hidden flex items-center justify-between p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-20">
                        <div className="flex items-center gap-2 font-bold text-indigo-600 dark:text-indigo-400">
                            <Book size={24} />
                            <span>Wiki</span>
                        </div>
                        <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">
                            {sidebarOpen ? <X size={24} /> : <Menu size={24} />}
                        </button>
                    </div>

                    {/* Sidebar */}
                    <aside className={`
                        fixed md:relative z-10 top-0 left-0 h-full w-72 
                        bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm md:bg-transparent
                        border-r border-slate-200 dark:border-slate-800
                        transform transition-transform duration-300 ease-in-out
                        flex flex-col
                        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0 md:w-0 md:overflow-hidden md:border-none'}
                    `}>
                        <div className="p-6 pb-2">
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-2 font-bold text-xl text-slate-800 dark:text-white">
                                    <Book className="text-indigo-600 dark:text-indigo-400" />
                                    <span>Wiki</span>
                                </div>
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-500">
                                    {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                                </button>
                            </div>

                            <div className="relative mb-6">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                <input 
                                    type="text"
                                    placeholder="Filter articles..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full pl-9 pr-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
                                />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 pb-6 custom-scrollbar">
                            {registryError && (
                                <div className="px-4 mb-4">
                                    <div className="bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 p-3 rounded text-xs border border-red-200 dark:border-red-800 break-words">
                                        <strong>Configuration Error</strong><br/>
                                        {registryError}
                                    </div>
                                </div>
                            )}
                            
                            {Object.entries(groupedArticles).map(([category, articles]) => (
                                <CategorySection 
                                    key={category} 
                                    title={category} 
                                    articles={articles} 
                                    currentArticle={activeArticle}
                                    onSelect={setActiveArticle}
                                />
                            ))}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 h-[calc(100vh-65px)] md:h-screen overflow-y-auto bg-white dark:bg-slate-950 relative w-full">
                        {!sidebarOpen && (
                            <button onClick={() => setSidebarOpen(true)} className="hidden md:flex absolute top-6 left-6 p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 shadow-sm z-10 transition-colors">
                                <Menu size={20} />
                            </button>
                        )}

                        <div className="max-w-4xl mx-auto px-6 py-12 md:py-20 min-h-full flex flex-col">
                            {activeArticle && (
                                <div className="flex items-center gap-2 text-sm text-slate-400 mb-6">
                                    <span>{activeArticle.category}</span>
                                    <ChevronRight size={14} />
                                    <span className="text-indigo-600 dark:text-indigo-400 font-medium">{activeArticle.title}</span>
                                </div>
                            )}

                            {loading ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-400 animate-pulse">
                                    <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-1/2 mb-4"></div>
                                    <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-3/4 mb-4"></div>
                                    <div className="h-4 bg-slate-200 dark:bg-slate-800 rounded w-2/3"></div>
                                </div>
                            ) : (
                                <article className="prose prose-slate dark:prose-invert lg:prose-lg max-w-none" onClick={handleContentClick}>
                                    <div dangerouslySetInnerHTML={{ __html: content }} />
                                    {error && (
                                        <div className="mt-8 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-amber-800 dark:text-amber-200 flex items-start gap-3">
                                            <AlertCircle className="shrink-0 mt-1" />
                                            <div>
                                                <h4 className="font-bold">Error Loading File</h4>
                                                <p className="text-sm mt-1">
                                                    Could not find: <code>{activeArticle?.path}</code>.<br/>
                                                    Check that the file exists in the repo and the name matches exactly (case-sensitive).
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </article>
                            )}

                            <div className="mt-auto pt-20 border-t border-slate-100 dark:border-slate-900">
                                <div className="flex items-center justify-between text-slate-400 text-sm">
                                    <p>© 2025 Personal Wiki</p>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PersonalWiki />);
    </script>
</body>
</html>
